/* =========================
   GLOBAL
   ========================= */
*{ box-sizing:border-box; margin:0; padding:0; }

body{
  min-height:100vh;
  min-height:100dvh;
  background:#f2dede;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:"Segoe UI",sans-serif;
  overflow:hidden;
}

/* =========================
   MAIN PHONE SCREEN
   ========================= */
.phone{
  width:100%;
  max-width:420px;
  height:100vh;
  height:100dvh;
  background:#fdeaea;
  padding:40px 20px;

  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;

  text-align:center;
  position:relative;
  overflow:hidden;
}

.line{ margin-top:8px; color:#6b4b4b; opacity:.9; }

.timer-box{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  margin:20px 0;
}

.time{
  background:#fff;
  padding:12px;
  border-radius:15px;
  width:65px;
  box-shadow:0 6px 14px rgba(0,0,0,.05);
}
.time span{ font-size:22px; font-weight:700; color:#ff4d6d; }
.status{ font-size:1.4rem; margin:15px 0; }

.name{ color:#ff2f92; font-weight:800; }

.loading{
  background:linear-gradient(270deg,#ff2f92,#ff7eb3,#ffc2d1);
  background-size:400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 6s linear infinite;
}
.birthday-glow{
  background:linear-gradient(270deg,red,orange,yellow,green,cyan);
  background-size:400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 10s linear infinite;
}
@keyframes rainbow{
  0%{ background-position:0%; }
  100%{ background-position:400%; }
}

/* Buttons */
button{
  padding:14px 35px;
  border-radius:30px;
  border:none;
  color:#fff;
  cursor:pointer;
  touch-action:manipulation;
}

#btn{
  margin-top:20px;
  font-size:1.05rem;
  padding:15px 38px;
  border-radius:35px;
  background:linear-gradient(135deg,#ff4d6d,#ff2f92);
  box-shadow:0 10px 25px rgba(255,47,146,.35);
  animation:pulse 1.6s infinite alternate;
}

#btn:disabled{
  opacity:.6;
  cursor:not-allowed;
  animation:none;
  box-shadow:none;
}

@keyframes pulse{
  from{ transform:scale(1); box-shadow:0 10px 22px rgba(255,47,146,.30); }
  to{ transform:scale(1.06); box-shadow:0 12px 28px rgba(255,47,146,.55); }
}

/* =========================
   POPUP
   ========================= */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}

.popup-card{
  background:#fff;
  padding:28px;
  border-radius:25px;
  width:82%;
  max-width:340px;
  text-align:center;
  box-shadow:0 18px 45px rgba(0,0,0,.18);
}

.popup-buttons{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-top:16px;
}

.yes-btn{ background:linear-gradient(135deg,#ff4d6d,#ff2f92); }
.no-btn{ background:#9b8a8a; }

/* =========================
   CELEBRATION SCREEN
   Smooth night crossfade (NO stepping)
   ========================= */
.celebration{
  position:fixed;
  inset:0;
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  z-index:40;
  overflow:hidden;

  /* base day */
  background:radial-gradient(circle at top,#fdeaea 0%,#f7c6d6 45%,#f2a7c0 100%);
}

/* dusk layer */
.celebration::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:0;
  background:radial-gradient(circle at top,#7d8fd6 0%,#3a4f9b 48%,#1a2a5d 100%);
}

/* deep night layer */
.celebration::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:0;
  background:radial-gradient(circle at top,#12264b 0%,#0b1430 55%,#050a18 100%);
}

/* animation */
.celebration.night-transition::before{ animation:duskFade 10s ease forwards; }
.celebration.night-transition::after{  animation:nightFade 10s ease forwards; }

@keyframes duskFade{
  0%{ opacity:0; }
  25%{ opacity:1; }
  65%{ opacity:1; }
  100%{ opacity:0; }
}

@keyframes nightFade{
  0%{ opacity:0; }
  45%{ opacity:0; }
  100%{ opacity:1; }
}

/* =========================
   DIM OVERLAY (IMPORTANT FIX)
   (separate layer, NOT ::before)
   ========================= */
.dim-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.42);
  opacity:0;
  pointer-events:none;
  transition:opacity .45s ease;
  z-index:8;
}
.celebration.dim .dim-overlay{
  opacity:1;
  pointer-events:auto;
}

/* =========================
   STAGE LAYOUT
   ========================= */
.stage{
  position:relative;
  z-index:2;

  width:100%;
  max-width:420px;
  min-height:100vh;
  min-height:100dvh;
  padding:30px 20px;

  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
  text-align:center;

  overflow:hidden;
}

/* =========================
   STARS / NIGHT OVERLAY
   ========================= */
.night-overlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:0;
  transition:opacity 5s ease;
  background:
    radial-gradient(circle at 20% 15%, rgba(180,220,255,.18) 0 2px, transparent 3px),
    radial-gradient(circle at 70% 22%, rgba(180,220,255,.14) 0 2px, transparent 3px),
    radial-gradient(circle at 50% 10%, rgba(180,220,255,.12) 0 1px, transparent 2px),
    radial-gradient(circle at 85% 35%, rgba(180,220,255,.10) 0 2px, transparent 3px),
    radial-gradient(circle at 30% 40%, rgba(180,220,255,.10) 0 1px, transparent 2px);
  mix-blend-mode:screen;
  z-index:1;
}
.celebration.night-transition #nightOverlay{ opacity:1; }

/* =========================
   FIREFLIES
   ========================= */
#fireflyLayer{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:1;
  overflow:hidden;
}
.firefly{
  position:absolute;
  border-radius:50%;
  opacity:0;
  background:radial-gradient(circle, rgba(255,255,210,1) 0%, rgba(255,255,210,.2) 55%, transparent 70%);
  filter:blur(.2px);
  animation: ffFloat var(--dur,8s) ease-in-out infinite,
             ffGlow 1.8s ease-in-out infinite;
}
@keyframes ffGlow{
  0%{ opacity:.15; transform:scale(.85); }
  50%{ opacity:.95; transform:scale(1.25); }
  100%{ opacity:.20; transform:scale(.9); }
}
@keyframes ffFloat{
  0%{ transform:translate(0,0); }
  25%{ transform:translate(18px,-22px); }
  50%{ transform:translate(-14px,-48px); }
  75%{ transform:translate(12px,-28px); }
  100%{ transform:translate(0,0); }
}

/* =========================
   HANGING FLAGS / BANNERS
   ========================= */
.flags{
  position:absolute;
  top:8px;
  left:50%;
  transform:translateX(-50%);
  width:110%;
  display:flex;
  justify-content:center;
  gap:6px;
  z-index:3;
  opacity:0;
  transform-origin:top;
  transition:opacity .9s ease, transform .9s ease;
  pointer-events:none;
}
.flags.show{
  opacity:1;
  transform:translateX(-50%) translateY(0);
  animation:flagsSway 3.5s ease-in-out infinite;
}
@keyframes flagsSway{
  0%{ transform:translateX(-50%) rotate(-.8deg); }
  50%{ transform:translateX(-50%) rotate(.8deg); }
  100%{ transform:translateX(-50%) rotate(-.8deg); }
}
.flags span{
  width:0;
  height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-top:24px solid #ff4d6d;
  filter:drop-shadow(0 6px 10px rgba(0,0,0,.12));
  transform-origin:top;
  animation:flagWiggle 1.6s ease-in-out infinite;
}
.flags span:nth-child(4n+1){ border-top-color:#ff4d6d; }
.flags span:nth-child(4n+2){ border-top-color:#ffd166; }
.flags span:nth-child(4n+3){ border-top-color:#06d6a0; }
.flags span:nth-child(4n){   border-top-color:#c77dff; }
@keyframes flagWiggle{
  0%{ transform:rotate(-2deg); }
  50%{ transform:rotate(2deg); }
  100%{ transform:rotate(-2deg); }
}

/* =========================
   BANNER + TEXT
   ========================= */
.banner{
  width:100%;
  background:#ff4d6d;
  color:#fff;
  padding:14px 10px;
  border-radius:18px;
  transform:translateY(-120px);
  opacity:0;
  transition:.9s ease;
  margin-top:20px;
  z-index:4;
}
.banner span{ font-weight:700; letter-spacing:.5px; }
.banner.show{ transform:translateY(0); opacity:1; }

.happy{
  margin-top:22px;
  font-size:2rem;
  font-weight:800;
  color:#ff2f5c;
  opacity:0;
  transform:scale(.8);
  transition:.8s ease;
  z-index:4;
}
.happy.show{ opacity:1; transform:scale(1); }

/* =========================
   CONFETTI
   ========================= */
#confettiLayer{
  position:fixed;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  z-index:999;
}
.confetti{
  position:absolute;
  opacity:.95;
  border-radius:2px;
  animation:fall 2.8s linear forwards;
}
@keyframes fall{
  to{ transform:translateY(110vh) rotate(720deg); opacity:1; }
}

/* =========================
   CAKE 3D
   ========================= */
.cake-wrap{
  margin-top:30px;
  opacity:0;
  transform:translateY(40px);
  transition:.9s ease;
  position:relative;
  z-index:5;
}
.cake-wrap.show{
  opacity:1;
  transform:translateY(0);
  animation:cakePop 900ms cubic-bezier(.2,.9,.2,1) both,
           cakeBob 3.2s ease-in-out 1.1s infinite;
}
@keyframes cakePop{
  0%{ transform:translateY(55px) scale(.92); opacity:0; }
  65%{ transform:translateY(-6px) scale(1.03); opacity:1; }
  100%{ transform:translateY(0) scale(1); opacity:1; }
}
@keyframes cakeBob{
  0%,100%{ transform:translateY(0); }
  50%{ transform:translateY(-8px); }
}

.cake3d{ width:220px; height:220px; position:relative; margin:0 auto; }

.plate{
  position:absolute;
  left:50%;
  bottom:12px;
  width:210px;
  height:26px;
  transform:translateX(-50%);
  background:rgba(255,255,255,.85);
  border-radius:20px;
  box-shadow:0 16px 30px rgba(0,0,0,.18);
}

.tier{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  border-radius:18px;
  box-shadow:0 14px 24px rgba(0,0,0,.12);
  overflow:hidden;
}
.tier-1{ bottom:30px; width:200px; height:70px; background:linear-gradient(180deg,#ff8fa3,#ff6b86); }
.tier-2{ bottom:92px; width:170px; height:60px; background:linear-gradient(180deg,#ffb3c1,#ff8fab); }
.tier-3{ bottom:145px; width:140px; height:50px; background:linear-gradient(180deg,#ffd1dc,#ffb3c1); }

.drip{
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 15% 0%, rgba(255,255,255,.9) 0 14px, transparent 15px),
    radial-gradient(circle at 45% 0%, rgba(255,255,255,.9) 0 16px, transparent 17px),
    radial-gradient(circle at 75% 0%, rgba(255,255,255,.9) 0 14px, transparent 15px);
  opacity:.55;
  mix-blend-mode:screen;
  animation:icingShine 3.2s ease-in-out infinite;
}
@keyframes icingShine{
  0%,100%{ opacity:.35; }
  50%{ opacity:.70; }
}

.sprinkles{
  position:absolute; inset:0;
  background:
    radial-gradient(circle, #ffd166 0 2px, transparent 3px) 20px 18px / 42px 42px repeat,
    radial-gradient(circle, #06d6a0 0 2px, transparent 3px) 10px 30px / 46px 46px repeat,
    radial-gradient(circle, #c77dff 0 2px, transparent 3px) 32px 26px / 48px 48px repeat;
  opacity:.65;
}

.candle{
  position:absolute;
  left:50%;
  bottom:188px;
  width:14px;
  height:48px;
  transform:translateX(-50%);
  background:#fff;
  border-radius:10px;
  box-shadow:0 10px 18px rgba(0,0,0,.12);
}
.wick{
  position:absolute;
  left:50%;
  top:-8px;
  width:2px;
  height:10px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.55);
  border-radius:2px;
}
.flame{
  position:absolute;
  left:50%;
  top:-22px;
  width:18px;
  height:18px;
  transform:translateX(-50%) rotate(45deg);
  background:#ffd166;
  border-radius:5px;
  box-shadow:0 0 18px rgba(255,209,102,.75);
  animation:flicker2 .75s ease-in-out infinite alternate;
}
@keyframes flicker2{
  from{ transform:translateX(-50%) rotate(45deg) scale(.95); opacity:.85; }
  to{ transform:translateX(-50%) rotate(45deg) scale(1.18); opacity:1; }
}

/* =========================
   ENVELOPE (CLEAN + FULLSCREEN + SCROLL)
   ========================= */
.envelope-wrap{
  margin-top:35px;
  opacity:0;
  transform:translateY(30px);
  transition:.9s ease;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:14px;
  position:relative;
  z-index:20; /* ✅ above overlays */
}
.envelope-wrap.show{ opacity:1; transform:translateY(0); }

.envelope2{
  width:260px;
  height:170px;
  position:relative;
  cursor:pointer;
  perspective:900px;
  z-index:21;
  transition: transform .65s cubic-bezier(.2,.9,.2,1), filter .5s ease;
}

/* layer order */
.env-back{
  position:absolute;
  inset:0;
  background:#fff;
  border-radius:18px;
  border:2px solid #ff4d6d;
  z-index:1;
}
.env-front{
  position:absolute;
  inset:0;
  background:#ffe3ea;
  border-radius:18px;
  border:2px solid #ff4d6d;
  z-index:2; /* ✅ below letter */
}
.env-flap{
  position:absolute;
  left:0; right:0;
  top:-2px;
  height:95px;
  background:#ffb3c1;
  border:2px solid #ff4d6d;
  border-bottom:none;
  border-radius:18px 18px 0 0;
  clip-path:polygon(0 0, 100% 0, 50% 100%);
  transform-origin:top;
  transform:rotateX(0deg);
  transition:transform .85s ease;
  z-index:5; /* ✅ topmost */
}

/* letter */
.letter{
  position:absolute;
  left:50%;
  top:18px;
  width:90%;
  height:88%;
  transform:translateX(-50%) translateY(28px);
  background:#fff;
  border-radius:14px;
  padding:14px;
  border:1px solid #ffd1dc;
  opacity:0;
  z-index:4; /* ✅ above front */
  transition: opacity .65s ease, transform .75s ease;
  overflow:hidden; /* closed */
}
.letter h3{ color:#ff2f5c; margin-bottom:8px; }
.letter p{ color:#333; line-height:1.45rem; }
.sign{ margin-top:10px; font-weight:700; }

/* open state */
.envelope2.open .env-flap{ transform:rotateX(180deg); }
.envelope2.open .letter{
  opacity:1;
  transform:translateX(-50%) translateY(0);
  overflow-y:auto;                  /* ✅ scroll */
  -webkit-overflow-scrolling:touch; /* ✅ iPhone smooth */
  height:92%;
  padding-right:10px;
  scroll-behavior:smooth;
}

/* nice scrollbar (chrome) */
.envelope2.open .letter::-webkit-scrollbar{ width:6px; }
.envelope2.open .letter::-webkit-scrollbar-thumb{
  background: rgba(255,47,92,.45);
  border-radius:10px;
}

/* fullscreen modal zoom */
.envelope2.open{
  position:fixed;
  left:50%;
  top:52%;
  transform:translate(-50%,-50%) scale(1.9);
  z-index:9999;
  filter:drop-shadow(0 35px 85px rgba(0,0,0,.50));
}

/* readability when scaled */
.envelope2.open .letter p{
  font-size:1.05rem;
  line-height:1.45rem;
}

/* button */
.open-btn{
  padding:12px 26px;
  border-radius:30px;
  border:none;
  background:#ff4d6d;
  color:#fff;
  cursor:pointer;
  position:relative;
  z-index:10;
}
